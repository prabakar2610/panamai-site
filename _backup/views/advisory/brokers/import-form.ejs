<div class="portfolio-import-form">
    <div class="text-center mb-4">
        <div class="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center" style="background: <%= broker.color %>15; color: <%= broker.color %>">
            <i class="fas fa-upload text-2xl"></i>
        </div>
        <h4 class="text-lg font-semibold text-gray-900">Import Portfolio from <%= broker.name %></h4>
        <p class="text-gray-600">Upload your portfolio data via CSV or Excel file</p>
    </div>

    <form id="importPortfolioForm" onsubmit="importPortfolio(event, '<%= broker.id %>')">
        <div class="space-y-4">
            <!-- File Upload Section -->
            <div>
                <label class="form-label">
                    <i class="fas fa-file-csv text-gray-500 mr-2"></i>
                    Portfolio File
                </label>
                <input type="file" 
                       name="portfolioFile" 
                       id="portfolioFile"
                       class="form-control" 
                       accept=".csv,.xlsx,.xls"
                       required>
                <small class="text-gray-500">
                    Supported formats: CSV, Excel (.xlsx, .xls) | Max size: 5MB
                </small>
            </div>

            <!-- File Preview -->
            <div id="filePreview" class="d-none">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                            <div class="flex-grow-1">
                                <div class="font-medium" id="fileName"></div>
                                <small class="text-gray-500" id="fileSize"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Template Selection -->
            <div>
                <label class="form-label">
                    <i class="fas fa-template text-gray-500 mr-2"></i>
                    Import Template
                </label>
                <select name="templateType" class="form-select" onchange="updateTemplateInfo(this.value)">
                    <% if (templates[broker.id]) { %>
                        <option value="<%= broker.id %>"><%= templates[broker.id].name %></option>
                    <% } %>
                    <option value="generic">Generic Portfolio Format</option>
                </select>
                <small class="text-gray-500">Choose the format that matches your file structure</small>
            </div>

            <!-- Template Information -->
            <div id="templateInfo" class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h6 class="font-semibold text-gray-900 mb-2">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    Expected Columns
                </h6>
                <div id="templateColumns" class="text-sm text-gray-700">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Import Options -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
            <h6 class="font-semibold text-blue-900 mb-3">Import Options</h6>
            <div class="space-y-3">
                <div class="form-check">
                    <input type="checkbox" 
                           name="replaceExisting" 
                           id="replaceExisting" 
                           class="form-check-input"
                           checked>
                    <label class="form-check-label" for="replaceExisting">
                        <strong>Replace existing holdings</strong>
                        <br><small class="text-gray-600">
                            Clear current holdings and import new data
                        </small>
                    </label>
                </div>

                <div class="form-check">
                    <input type="checkbox" 
                           name="skipErrors" 
                           id="skipErrors" 
                           class="form-check-input"
                           checked>
                    <label class="form-check-label" for="skipErrors">
                        <strong>Skip invalid rows</strong>
                        <br><small class="text-gray-600">
                            Continue importing even if some rows have errors
                        </small>
                    </label>
                </div>

                <div class="form-check">
                    <input type="checkbox" 
                           name="updatePrices" 
                           id="updatePrices" 
                           class="form-check-input">
                    <label class="form-check-label" for="updatePrices">
                        <strong>Update current prices</strong>
                        <br><small class="text-gray-600">
                            Fetch latest market prices for imported holdings
                        </small>
                    </label>
                </div>
            </div>
        </div>

        <!-- Sample Template Download -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
            <div class="d-flex align-items-start">
                <i class="fas fa-download text-green-600 mr-3 mt-1"></i>
                <div class="flex-grow-1">
                    <h6 class="font-semibold text-green-900 mb-2">Download Sample Template</h6>
                    <p class="text-sm text-green-800 mb-3">
                        Download a sample template to see the expected format for your data.
                    </p>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadTemplate('<%= broker.id %>')">
                        <i class="fas fa-download mr-1"></i>
                        Download <%= broker.name %> Template
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-3 mt-4">
            <button type="button" class="btn btn-secondary flex-1" data-bs-dismiss="modal">
                Cancel
            </button>
            <button type="submit" class="btn btn-primary flex-1" id="importBtn" disabled>
                <i class="fas fa-upload mr-2"></i>
                Import Portfolio
            </button>
        </div>
    </form>
</div>

<script>
const templates = <%- JSON.stringify(templates) %>;

// File handling
document.getElementById('portfolioFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        showFilePreview(file);
        document.getElementById('importBtn').disabled = false;
    } else {
        hideFilePreview();
        document.getElementById('importBtn').disabled = true;
    }
});

function showFilePreview(file) {
    const preview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    
    preview.classList.remove('d-none');
}

function hideFilePreview() {
    document.getElementById('filePreview').classList.add('d-none');
}

function removeFile() {
    document.getElementById('portfolioFile').value = '';
    hideFilePreview();
    document.getElementById('importBtn').disabled = true;
}

function formatFileSize(bytes) {
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    if (bytes === 0) return '0 Bytes';
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

// Template handling
function updateTemplateInfo(templateType) {
    const template = templates[templateType];
    const columnsDiv = document.getElementById('templateColumns');
    
    if (template) {
        const columns = template.columns.map(col => 
            `<span class="badge bg-primary me-1 mb-1">${col}</span>`
        ).join('');
        
        columnsDiv.innerHTML = `
            <div class="mb-2">
                <strong>Format:</strong> ${template.format}
            </div>
            <div>
                <strong>Required Columns:</strong><br>
                ${columns}
            </div>
        `;
    } else {
        columnsDiv.innerHTML = '<span class="text-gray-500">Select a template to see column information</span>';
    }
}

// Portfolio import
async function importPortfolio(event, brokerId) {
    event.preventDefault();
    
    try {
        const fileInput = document.getElementById('portfolioFile');
        const file = fileInput.files[0];
        
        if (!file) {
            showToast('Please select a file to import', 'error');
            return;
        }
        
        // Validate file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
            showToast('File size exceeds 5MB limit', 'error');
            return;
        }
        
        // Validate file type
        const allowedTypes = ['.csv', '.xlsx', '.xls'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(fileExtension)) {
            showToast('Invalid file type. Please upload CSV or Excel files only.', 'error');
            return;
        }
        
        showLoading('Importing portfolio data...');
        
        const formData = new FormData();
        formData.append('portfolioFile', file);
        
        // Add import options
        const form = event.target;
        formData.append('replaceExisting', form.replaceExisting.checked);
        formData.append('skipErrors', form.skipErrors.checked);
        formData.append('updatePrices', form.updatePrices.checked);
        formData.append('templateType', form.templateType.value);
        
        const response = await fetch(`/brokers/${brokerId}/import`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('importPortfolioModal'));
            modal.hide();
            
            showToast(data.data.message, 'success');
            
            // Show import summary
            setTimeout(() => {
                showImportSummary(data.data);
            }, 1500);
            
            // Reload page to show updated data
            setTimeout(() => {
                location.reload();
            }, 4000);
        } else {
            showToast(data.error || 'Failed to import portfolio', 'error');
        }
    } catch (error) {
        console.error('Error importing portfolio:', error);
        showToast('Error importing portfolio', 'error');
    } finally {
        hideLoading();
    }
}

function showImportSummary(data) {
    const summaryHtml = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="fas fa-check-circle"></i>
                Import Successful!
            </h5>
            <div class="mt-3">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="h4 text-success">${data.holdingsImported}</div>
                        <small class="text-muted">Holdings Imported</small>
                    </div>
                    <div class="col-md-4">
                        <div class="h4 text-primary">â‚¹${data.totalValue.toLocaleString()}</div>
                        <small class="text-muted">Total Value</small>
                    </div>
                    <div class="col-md-4">
                        <div class="h4 text-info"><%= broker.name %></div>
                        <small class="text-muted">Broker</small>
                    </div>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.createElement('div');
    container.innerHTML = summaryHtml;
    document.body.appendChild(container);
    
    // Auto remove after 8 seconds
    setTimeout(() => {
        container.remove();
    }, 8000);
}

function downloadTemplate(brokerId) {
    // Create a sample CSV content based on the broker
    const template = templates[brokerId] || templates.generic;
    let csvContent = template.columns.join(',') + '\n';
    
    // Add sample data
    if (brokerId === 'axis_direct') {
        csvContent += 'RELIANCE,100,2500.50,2600.75,260075,-10075\n';
        csvContent += 'TCS,50,3200.25,3400.80,170040,10008\n';
        csvContent += 'HDFCBANK,75,1450.60,1520.30,114023,5228\n';
    } else if (brokerId === 'indmoney') {
        csvContent += 'Reliance Industries,100,2500.50,2600.75,260075\n';
        csvContent += 'Tata Consultancy Services,50,3200.25,3400.80,170040\n';
        csvContent += 'HDFC Bank,75,1450.60,1520.30,114023\n';
    } else {
        csvContent += 'RELIANCE,NSE,100,2500.50,2600.75\n';
        csvContent += 'TCS,NSE,50,3200.25,3400.80\n';
        csvContent += 'HDFCBANK,NSE,75,1450.60,1520.30\n';
    }
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${brokerId}_portfolio_template.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showToast('Template downloaded successfully', 'success');
}

// Initialize template info on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTemplateInfo('<%= broker.id %>');
});
</script>